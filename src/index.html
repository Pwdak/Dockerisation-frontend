<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur QR Code Carte eID - YHDAA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #003F8C 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #003F8C 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .scanner-section {
            margin-bottom: 30px;
        }

        .input-area {
            position: relative;
            margin-bottom: 20px;
        }

        #qrInput {
            width: 100%;
            padding: 20px;
            font-size: 16px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            text-align: center;
            outline: none;
            transition: all 0.3s;
            font-family: monospace;
        }

        #qrInput:focus {
            border-color: #003F8C;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        #qrInput.receiving {
            border-color: #4caf50;
            background: #e8f5e9;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
        }

        .instructions {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #e65100;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.receiving {
            background: #fff3e0;
            color: #f57c00;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        .status-icon {
            font-size: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #003F8C 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .data-display {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 25px;
            display: none;
        }

        .data-display.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-grid {
            display: grid;
            gap: 15px;
        }

        .data-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .data-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            word-break: break-word;
        }

        .raw-data {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .raw-data-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
        }

        .device-info {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #2e7d32;
        }

        /* CSS carte styl√©e de type fiche d‚Äôidentit√© */
        .id-card {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            gap: 30px;
            border-left: 6px solid #667eea;
            margin-top: 20px;
        }

        .id-photo img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }

        .id-info {
            flex: 1;
        }

        .id-info h2 {
            margin-bottom: 10px;
            color: #333;
            font-size: 20px;
            text-transform: uppercase;
        }

        .id-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding: 6px 0;
        }

        .id-label {
            font-weight: bold;
            color: #444;
        }

        .id-value {
            color: #333;
        }

        .niu {
            text-align: center;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
        }

        /* Footer css */
        .footer {
            /* background-color: #0a0a0a; */
            background: linear-gradient(135deg, #667eea 0%, #003F8C 100%);
            color: #ffffff;
            padding: 15px 0;
            margin-top: auto;
            position: relative;
            bottom: 0;
            width: 100%;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;

            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-text {
            margin: 0;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .footer-logo {
            height: 35px;
            width: auto;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .footer-container {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1> Lecteur QR Code eID - YHDAA</h1>
            <p>Branchez votre Lecteur USB pour scanner la carte biom√©trique eID</p>
        </div>

        <div class="content">
            <div class="scanner-section">
                <!-- <div class="instructions">
                    <h3>üìñ Instructions d'utilisation :</h3>
                    <ol>
                        <li>Assurez-vous que votre lecteur YHDAA est branch√© √† votre PC</li>
                        <li>Cliquez dans la zone de saisie ci-dessous (elle doit √™tre active)</li>
                        <li>Scannez le QR code de votre carte eID avec le lecteur</li>
                        <li>Les donn√©es seront automatiquement captur√©es et affich√©es</li>
                    </ol>
                </div> -->

                <div id="status" class="status waiting">
                    <span class="status-icon">‚è≥</span>
                    <span>En attente du scan - Cliquez dans la zone ci-dessous puis scannez</span>
                </div>

                <!-- <div class="device-info">
                    ‚úì Lecteur USB d√©tect√© - Pr√™t √† recevoir les donn√©es
                </div> -->

                <div class="input-area">
                    <input type="text" id="qrInput"
                        placeholder="Cliquez ici puis scannez votre QR code avec le lecteur YHDAA..."
                        autocomplete="off">
                </div>

                <button onclick="clearData()">üîÑ Nouveau Scan</button>
            </div>

            <div id="dataDisplay" class="data-display">
                <h2 style="margin-bottom: 20px; color: #333;">üìã Informations de la Carte</h2>
                <div id="dataGrid" class="data-grid"></div>
                <!-- <div class="raw-data">
                    <div class="raw-data-title">Donn√©es brutes du QR Code:</div>
                    <div id="rawData"></div>

                </div> -->
            </div>
        </div>
        <div class="footer">
            <div class="footer-container">
                <p class="footer-text">¬© COPYRIGHT 2025</p>
                <img src="anid_blanc.svg" alt="ANID Logo" class="footer-logo" />
            </div>
        </div>
    </div>
    <script src="simple-image-decoder.js"></script>
    <script>
        const decoder = new SimpleImageDecoderService();
        const qrInput = document.getElementById('qrInput');
        const status = document.getElementById('status');
        let scanTimeout = null;
        let isScanning = false;

        // Focus automatique au chargement
        window.addEventListener('load', () => {
            qrInput.focus();
        });

        // Garder le focus sur l'input
        qrInput.addEventListener('blur', () => {
            setTimeout(() => {
                if (!document.getElementById('dataDisplay').classList.contains('active')) {
                    qrInput.focus();
                }
            }, 100);
        });

        // D√©tection de la saisie du lecteur
        qrInput.addEventListener('input', (e) => {
            if (!isScanning) {
                isScanning = true;
                updateStatus('R√©ception des donn√©es...', 'receiving', 'üì•');
                qrInput.classList.add('receiving');
            }

            // R√©initialiser le timeout
            clearTimeout(scanTimeout);

            // Attendre 500ms apr√®s la derni√®re saisie pour consid√©rer le scan termin√©
            scanTimeout = setTimeout(() => {
                const data = qrInput.value.trim();
                if (data) {
                    processQRData(data);
                }
                isScanning = false;
                qrInput.classList.remove('receiving');
            }, 500);
        });

        // D√©tection de la touche Entr√©e (certains lecteurs envoient Enter √† la fin)
        qrInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(scanTimeout);
                const data = qrInput.value.trim();
                if (data) {
                    processQRData(data);
                }
                isScanning = false;
                qrInput.classList.remove('receiving');
            }
        });

        function updateStatus(message, type = 'waiting', icon = '‚è≥') {
            status.innerHTML = `
                <span class="status-icon">${icon}</span>
                <span>${message}</span>
            `;
            status.className = `status ${type}`;
        }

        function processQRData(data) {
            updateStatus('QR Code scann√© avec succ√®s!', 'success', '‚úÖ');

            // Afficher les donn√©es brutes
            // document.getElementById('rawData').textContent = data;

            // Parser les donn√©es selon le format eID
            const parsedData = parseIdentityString(data);
            console.log(parsedData);
            displayData(parsedData);

            // Vider l'input pour le prochain scan
            qrInput.value = '';
        }

        function parseEIDData(data) {
            const fields = {};

            // Format MRZ (Machine Readable Zone) - utilis√© par de nombreuses cartes eID
            if (data.includes('<<') || /^[A-Z0-9<]+$/.test(data.substring(0, 20))) {
                const lines = data.split(/[\n\r]+/).filter(l => l.trim());

                if (lines.length > 0) {
                    // Premi√®re ligne MRZ
                    const line1 = lines[0];
                    if (line1.length >= 30) {
                        fields['Type de document'] = line1.substring(0, 2);
                        fields['Code pays'] = line1.substring(2, 5).replace(/<+/g, '');
                        const namePart = line1.substring(5).split('<<');
                        if (namePart.length >= 2) {
                            fields['Nom'] = namePart[0].replace(/<+/g, ' ').trim();
                            fields['Pr√©nom'] = namePart[1].replace(/<+/g, ' ').trim();
                        }
                    }
                }

                if (lines.length > 1) {
                    // Deuxi√®me ligne MRZ
                    const line2 = lines[1];
                    if (line2.length >= 30) {
                        fields['Num√©ro de document'] = line2.substring(0, 9).replace(/<+/g, '');
                        fields['Nationalit√©'] = line2.substring(10, 13).replace(/<+/g, '');

                        const birthDate = line2.substring(13, 19);
                        if (birthDate && birthDate !== '<<<<<<') {
                            fields['Date de naissance'] = formatDate(birthDate);
                        }

                        fields['Sexe'] = line2.substring(20, 21);

                        const expDate = line2.substring(21, 27);
                        if (expDate && expDate !== '<<<<<<') {
                            fields['Date d\'expiration'] = formatDate(expDate);
                        }
                    }
                }

                fields['Format'] = 'MRZ (Machine Readable Zone)';
            }
            // Format avec s√©parateurs
            else if (data.includes('|')) {
                const parts = data.split('|');
                const labels = ['Nom', 'Pr√©nom', 'Date de naissance', 'Num√©ro de document', 'Date d\'expiration', 'Nationalit√©', 'Sexe', 'Lieu de naissance'];
                parts.forEach((part, idx) => {
                    if (part && part.trim() && idx < labels.length) {
                        fields[labels[idx]] = part.trim();
                    }
                });
            }
            // Format cl√©:valeur
            else if (data.includes(':')) {
                const pairs = data.split(/[,;\n\r]/);
                pairs.forEach(pair => {
                    const [key, value] = pair.split(':').map(s => s.trim());
                    if (key && value) {
                        fields[key] = value;
                    }
                });
            }
            // Format JSON
            else if (data.trim().startsWith('{')) {
                try {
                    const jsonData = JSON.parse(data);
                    Object.assign(fields, jsonData);
                } catch (e) {
                    fields['Donn√©es'] = data;
                }
            }

            // Si aucun format reconnu
            if (Object.keys(fields).length === 0) {
                fields['Donn√©es brutes'] = data;
                fields['Note'] = 'Format non reconnu - Donn√©es affich√©es telles quelles';
            }

            // Ajouter des informations de m√©tadonn√©es
            fields['Longueur des donn√©es'] = data.length + ' caract√®res';
            fields['Date de scan'] = new Date().toLocaleString('fr-FR');

            return fields;
        }

        function formatDate(yymmdd) {
            if (!yymmdd || yymmdd.length !== 6) return yymmdd;

            const yy = yymmdd.substring(0, 2);
            const mm = yymmdd.substring(2, 4);
            const dd = yymmdd.substring(4, 6);

            // D√©terminer le si√®cle (si > 50, c'est 19xx, sinon 20xx)
            const year = parseInt(yy) > 50 ? '19' + yy : '20' + yy;

            return `${dd}/${mm}/${year}`;
        }

        // function displayData(data) {
        //     console.log(data); 
        //     const dataGrid = document.getElementById('dataGrid');
        //     dataGrid.innerHTML = '';

        //     for (const [label, value] of Object.entries(data)) {
        //         const item = document.createElement('div');
        //         item.className = 'data-item';
        //         item.innerHTML = `
        //             <div class="data-label">${label}</div>
        //             <div class="data-value">${value}</div>
        //         `;
        //         dataGrid.appendChild(item);
        //     }

        //     document.getElementById('dataDisplay').classList.add('active');
        // }

        function displayData(data) {
            const dataDisplay = document.getElementById('dataDisplay');
            const dataGrid = document.getElementById('dataGrid');
            dataGrid.innerHTML = '';

            // Cr√©ation de la carte d‚Äôidentit√©
            const card = document.createElement('div');
            card.className = 'id-card';

            // Bloc photo + NIU
            const photoDiv = document.createElement('div');
            photoDiv.className = 'id-photo';
            photoDiv.innerHTML = `
        <img src="${data.Face || 'user-default.png'}" alt="Photo ID">
        <div class="niu">NIU : ${data.individualId || 'Inconnu'}</div>
    `;

            // Bloc info texte
            const infoDiv = document.createElement('div');
            infoDiv.className = 'id-info';
            infoDiv.innerHTML = `
        <div class="id-row"><span class="id-label">Nom:</span><span class="id-value">${data.lastName_fra || ''}</span></div>
        <div class="id-row"><span class="id-label">Pr√©noms:</span><span class="id-value">${data.firstName_fra || ''}</span></div>
        <div class="id-row"><span class="id-label">Date de naissance:</span><span class="id-value">${data.dob || ''}</span></div>
        <div class="id-row"><span class="id-label">Sexe:</span><span class="id-value">${data.gender_fra || ''}</span></div>
         <div class="id-row"><span class="id-label">T√©l√©phone:</span><span class="id-value">${data.phoneNumber || ''}</span></div>          
    `;
            if (data.country?.length > 0) infoDiv.innerHTML += `<div class="id-row"><span class="id-label">Nationalit√©:</span><span class="id-value">${data.country || ''}</span></div>`
            if (data.email?.length > 0) infoDiv.innerHTML += `<div class="id-row"><span class="id-label">Email:</span><span class="id-value">${data.email || ''}</span></div>`

            // Ajout dans la carte
            card.appendChild(photoDiv);
            card.appendChild(infoDiv);

            // Ajout dans la page
            dataGrid.appendChild(card);
            dataDisplay.classList.add('active');
        }

        function clearData() {
            qrInput.value = '';
            document.getElementById('dataDisplay').classList.remove('active');
            document.getElementById('dataGrid').innerHTML = '';
            // document.getElementById('rawData').textContent = '';
            updateStatus('En attente du scan - Cliquez dans la zone puis scannez', 'waiting', '‚è≥');
            qrInput.focus();
        }



        // fonctions d'extrations

        // function parseIdentityString(input) {
        //     try {
        //         const parts = input.split(':');
        //         if (parts.length < 5) return {};

        //         const dataPart = parts[4]; // "413423798560/LOKOMO/BAKU+ALITAYI/1996%2F10%2F15/M/98502910"
        //         const fields = dataPart.split('/');

        //         if (fields.length < 7) return {};
        //         let face = this.extractBiometricImage(input);
        //         if (face == null) face = '';
        //         // Conversion de face en base64
        //         const resultFaceBase64 = decoder.convertBase32ToImage(face);
        //         return {
        //             country: this.nationalityFormatter(fields[6]),
        //             individualId: fields[0],
        //             lastName_fra: fields[1],
        //             firstName_fra: fields[2].replace(/\+/g, ' '),
        //             dob: decodeURIComponent(fields[3]), // D√©codage de %2F en /
        //             gender_fra: fields[4],
        //             phoneNumber: fields[5],
        //             Face: resultFaceBase64.dataUrl,
        //         };
        //     } catch (error) {
        //         console.error('Parsing failed:', error);
        //         return {};
        //     }
        // }

        // Cr√©er une instance du d√©codeur
        // const decoder = new SimpleImageDecoderService();

        function parseIdentityString(input) {
            try {
                console.log('=== DEBUT PARSING ===');

                const parts = input.split(':');
                if (parts.length < 5) return {};

                const dataPart = parts[4];
                const fields = dataPart.split('/');

                if (fields.length < 6) return {};

                // Extraction DEBUG de la photo
                console.log('=== EXTRACTION IMAGE DEBUG ===');
                const faceData = extractBiometricImageDebug(input);
                console.log('Donn√©es brutes extraites:', faceData ? `Longueur: ${faceData.length}` : 'NULL');

                let faceBase64 = '';
                if (faceData && decoder) {
                    try {
                        console.log('Tentative de d√©codage...');
                        const result = decoder.convertBase32ToImage(faceData);
                        console.log('R√©sultat d√©codage:', result);

                        if (result.success) {
                            faceBase64 = result.dataUrl;
                            console.log('D√©codage r√©ussi, MIME:', result.mimeType);
                        } else {
                            console.error('√âchec d√©codage:', result.error);
                        }
                    } catch (e) {
                        console.error('Erreur lors du d√©codage:', e);
                    }
                }

                // Extraction email et nationalit√©
                const { email, country } = extractEmailAndNationality(fields[6]);
                console.log('Email:', email);
                console.log('Country:', country);

                return {
                    country: country,
                    individualId: fields[0],
                    lastName_fra: fields[1],
                    firstName_fra: fields[2].replace(/\+/g, ' '),
                    dob: decodeURIComponent(fields[3]),
                    gender_fra: fields[4],
                    phoneNumber: fields[5],
                    email: email,
                    Face: faceBase64,
                };
            } catch (error) {
                console.error('Parsing failed:', error);
                return {};
            }
        }

        function extractBiometricImageDebug(encodedStr) {
            console.log('Recherche section image...');

            // M√©thode 1: Recherche simple
            const simpleMatch = encodedStr.match(/image%2F[^\/]+\/([^\/]+)\/([^\/]+)\/([A-Z2-7]+)/);
            if (simpleMatch) {
                console.log('M√©thode 1 r√©ussie - Donn√©es:', simpleMatch[3].substring(0, 50) + '...');
                return simpleMatch[3];
            }

            // M√©thode 2: Recherche par split
            const sections = encodedStr.split('/image%2F');
            if (sections.length > 1) {
                console.log('Section image trouv√©e via split');
                const afterImage = sections[1];
                const imageParts = afterImage.split('/');
                console.log('Parties apr√®s image:', imageParts.slice(0, 5));

                if (imageParts.length >= 4) {
                    const possibleData = imageParts[3];
                    if (possibleData && /^[A-Z2-7]+$/.test(possibleData)) {
                        console.log('M√©thode 2 r√©ussie - Donn√©es:', possibleData.substring(0, 50) + '...');
                        return possibleData;
                    }
                }
            }

            // M√©thode 3: Recherche manuelle
            console.log('Tentative m√©thode manuelle...');
            const imageIndex = encodedStr.indexOf('image%2F');
            if (imageIndex !== -1) {
                const remaining = encodedStr.substring(imageIndex);
                const parts = remaining.split('/');
                console.log('Structure compl√®te:', parts.slice(0, 6));

                // Chercher le premier bloc Base32 apr√®s le format
                for (let i = 4; i < Math.min(parts.length, 10); i++) {
                    const part = parts[i];
                    if (part && /^[A-Z2-7]{100,}$/.test(part)) {
                        console.log(`M√©thode 3 r√©ussie - Donn√©es index ${i}:`, part.substring(0, 50) + '...');
                        return part;
                    }
                }
            }

            console.log('Aucune m√©thode na fonctionn√©');
            return null;
        }

        function extractEmailAndNationality(field6) {
            let email = '';
            let country = '';

            if (!field6) return { email: '', country: '' };

            if (field6.includes('@') || field6.includes('%40')) {
                email = field6.includes('%40') ? decodeURIComponent(field6) : field6;
            } else {
                country = nationalityFormatter(field6);
            }

            return { email, country };
        }

        function extractBiometricImage(encodedStr) {
            // Version finale simplifi√©e
            const match = encodedStr.match(/image%2F[^\/]+\/([^\/]+)\/([^\/]+)\/([A-Z2-7]+)/);
            return match ? match[3] : null;
        }



        function nationalityFormatter(notFormattedNationality) {
            let formattedNationality = "";

            if (notFormattedNationality.includes("TG")) {
                formattedNationality = notFormattedNationality
                    .replace("TG", "TOGO")
                    .replace("-", " ")
                    .replace("C", "(CONFIRMEE)")
                    .replace("NC", "(NON CONFIRMEE)");
            } else {
                // Voici une approche alternative utilisant Intl.DisplayNames
                try {
                    // const regionNames = new Intl.DisplayNames(['fr'], { type: 'region' });

                    // Liste des codes pays ISO 3166-1 alpha-2 les plus courants
                    const isoCodes = [
                        'AD', 'AE', 'AF', 'AG', 'AI', 'AL', 'AM', 'AO', 'AQ', 'AR', 'AS', 'AT',
                        'AU', 'AW', 'AX', 'AZ', 'BA', 'BB', 'BD', 'BE', 'BF', 'BG', 'BH', 'BI',
                        'BJ', 'BL', 'BM', 'BN', 'BO', 'BQ', 'BR', 'BS', 'BT', 'BV', 'BW', 'BY',
                        'BZ', 'CA', 'CC', 'CD', 'CF', 'CG', 'CH', 'CI', 'CK', 'CL', 'CM', 'CN',
                        'CO', 'CR', 'CU', 'CV', 'CW', 'CX', 'CY', 'CZ', 'DE', 'DJ', 'DK', 'DM',
                        'DO', 'DZ', 'EC', 'EE', 'EG', 'EH', 'ER', 'ES', 'ET', 'FI', 'FJ', 'FK',
                        'FM', 'FO', 'FR', 'GA', 'GB', 'GD', 'GE', 'GF', 'GG', 'GH', 'GI', 'GL',
                        'GM', 'GN', 'GP', 'GQ', 'GR', 'GS', 'GT', 'GU', 'GW', 'GY', 'HK', 'HM',
                        'HN', 'HR', 'HT', 'HU', 'ID', 'IE', 'IL', 'IM', 'IN', 'IO', 'IQ', 'IR',
                        'IS', 'IT', 'JE', 'JM', 'JO', 'JP', 'KE', 'KG', 'KH', 'KI', 'KM', 'KN',
                        'KP', 'KR', 'KW', 'KY', 'KZ', 'LA', 'LB', 'LC', 'LI', 'LK', 'LR', 'LS',
                        'LT', 'LU', 'LV', 'LY', 'MA', 'MC', 'MD', 'ME', 'MF', 'MG', 'MH', 'MK',
                        'ML', 'MM', 'MN', 'MO', 'MP', 'MQ', 'MR', 'MS', 'MT', 'MU', 'MV', 'MW',
                        'MX', 'MY', 'MZ', 'NA', 'NC', 'NE', 'NF', 'NG', 'NI', 'NL', 'NO', 'NP',
                        'NR', 'NU', 'NZ', 'OM', 'PA', 'PE', 'PF', 'PG', 'PH', 'PK', 'PL', 'PM',
                        'PN', 'PR', 'PS', 'PT', 'PW', 'PY', 'QA', 'RE', 'RO', 'RS', 'RU', 'RW',
                        'SA', 'SB', 'SC', 'SD', 'SE', 'SG', 'SH', 'SI', 'SJ', 'SK', 'SL', 'SM',
                        'SN', 'SO', 'SR', 'SS', 'ST', 'SV', 'SX', 'SY', 'SZ', 'TC', 'TD', 'TF',
                        'TG', 'TH', 'TJ', 'TK', 'TL', 'TM', 'TN', 'TO', 'TR', 'TT', 'TV', 'TW',
                        'TZ', 'UA', 'UG', 'UM', 'US', 'UY', 'UZ', 'VA', 'VC', 'VE', 'VG', 'VI',
                        'VN', 'VU', 'WF', 'WS', 'YE', 'YT', 'ZA', 'ZM', 'ZW'
                    ];

                    // Voici une version corrig√©e qui cherche le bon code pays
                    for (const iso of isoCodes) {
                        if (notFormattedNationality.toUpperCase().includes(iso)) {
                            const countryName = regionNames.of(iso);
                            if (countryName) {
                                formattedNationality = countryName
                                    .toUpperCase()
                                    .replace(/ /g, "-")
                                    .replace(/ AND /g, "&");
                                break;
                            }
                        }
                    }
                } catch (error) {
                    // Fallback si Intl.DisplayNames n'est pas support√©
                    formattedNationality = notFormattedNationality.toUpperCase();
                }
            }

            return formattedNationality;
        }
    </script>
</body>

</html>